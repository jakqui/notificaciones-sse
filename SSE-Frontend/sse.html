<!DOCTYPE html>
<html>
<head>
	<title></title>	
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.0.1/css/toastr.css" />
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/css/bootstrap-select.min.css">
	<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap4.min.css">	
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/bbbootstrap/libraries@main/choices.min.css">
  	<link rel="stylesheet" href="./css/sweetalert.css" type="text/css" />
  	<link rel="stylesheet" type="text/css" href="./css/custom.css">	


	<script type="text/javascript">
		/*ESCUCHADOR DE NOTIFICACIONES*/		
		let es = null;
		//NOTIFICACIONES ANTERIORES DEL USUARIO
        var _notificaciones = [];
        var _numeroUsuario = 0;	
        var _baseURL = 'http://localhost:8484';

        
	</script>
	<style type="text/css">
		
	</style>
</head>
<body>

	<!-- START MENU**********************************************************************************************************************************************************************-->
	<nav class="navbar navbar-expand-lg navbar-light" style="background-color: #e3f2fd;">
		<button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarTogglerDemo01" aria-controls="navbarTogglerDemo01" aria-expanded="false" aria-label="Toggle navigation">
	    	<span class="navbar-toggler-icon"></span>
	  	</button>
	  	<a class="navbar-brand" href="#">SISTEMA DE NOTIFICACIONES</a>
	  	<div class="collapse navbar-collapse" id="navbarTogglerDemo01">	    	
		    <ul class="navbar-nav mr-auto mt-2 mt-lg-0 ">
		      	<li class="nav-item active">
		        	<a class="nav-link" style="cursor:pointer;" id="contenidoInicio" onclick="mostrarContenido(this.id)">Inicio <span class="sr-only">(current)</span></a>
		      	</li>
		      	<li class="nav-item dropdown">
			        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
			          Notificaciones
			        </a>
			        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
			          <a class="dropdown-item" style="cursor:pointer;" id="contenidoConectar" onclick="mostrarContenido(this.id)">Conectar Tema</a>
			          <a class="dropdown-item" style="cursor:pointer;" id="contenidoNotificar" onclick="mostrarContenido(this.id)">Crear Notificación</a>
			        </div>
			     </li>
		      	<li class="nav-item dropdown">
			        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
			          Usuarios
			        </a>
			        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
			          <a class="dropdown-item" style="cursor:pointer;" id="contenidoCrearUsuario" onclick="mostrarContenido(this.id)">Crear Usuario</a>
			          <!--<div class="dropdown-divider"></div>
			          <a class="dropdown-item" href="#">Something else here</a>-->
			        </div>
			    </li>
			    <li class="nav-item dropdown">
			        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
			          Temas
			        </a>
			        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
			          <a class="dropdown-item" style="cursor:pointer;" id="contenidoCrearTema" onclick="mostrarContenido(this.id)">Crear Tema</a>
			        </div>
			    </li>
		    </ul>		    
	  	</div>
	  	<div>
	  		<ul class="navbar-nav ml-auto mt-2 mt-lg-0 ">
	  			<li class="nav-item dropdown notifications-dropdown ml-auto">
	  				<label id="labelDesconectado" style="color:red">Desconectado</label>
					<label id="labelConectado" style="color:green;display: none">Conectado</label>
	  			</li>
	  			<li class="nav-item dropdown notifications-dropdown ml-auto">
			    	<a onclick="recorrerNotificaciones()" style="cursor:pointer;" type="button" data-toggle="dropdown" data-hover="dropdown" data-close-others="true">
                        <i class="bi-bell" style="font-size: 20px;"></i>
                        <span id="spanCantidadNotificacionesSinLeer" class="badge badge-success" style="background-color: #567891; font-size: 12px;"> 0 </span>
                    </a>

			        <div class="dropdown-menu" aria-labelledby="navbarDropdown" id="divVerNotificaciones">
			          	<div class="dropdown-menu-header">
				            Notificaciones
				        </div>
				        <div id="divNotificaciones"></div>
				        <div class="notifications-dropdown-footer">
					        Ver todas
				       	</div>
			        </div>
			    </li>
	  		</ul>
	  	</div>


	  	<!--<form class="form-inline my-2 my-lg-0">
		 	<input class="form-control mr-sm-2" type="search" placeholder="Search" aria-label="Search">
		   	<button class="btn btn-outline-success my-2 my-sm-0" type="submit">Buscar</button>
		</form>-->
	</nav>
	<!-- END MENU**********************************************************************************************************************************************************************-->




	<div id="divContenidoInicio" style="display: block" class="divsContenido">
		Inicio
	</div>



	<div id="divContenidoConectar" style="display: none" class="divsContenido">
		<div>
			<h1 style="text-align:center;">CONECTAR A TEMA</h1>
		</div>
		<br/>
		<div class="col-md-6 offset-md-3">
			<label>Usuario:</label>
			<select id="selectUsuario" class="selectpicker" data-live-search="true" placeholder="Nada seleccionado"> </select>
			<button class="btn btn-info" type="button" onclick="conectar()"><i class="bi-arrow-repeat"></i> Conectar</button>
			<button class="btn btn-danger" type="button" onclick="cerrarConexion()"><i class="bi-x-circle-fill"></i> Cerrar Conexión</button>
		</div>
		<br/>
		<div id="divTemasConexionUsuario" class="col-md-6 offset-md-3">
			<label><strong>Temas a los que está conectado el usuario</strong></label>
			<br/>
			<table id="tablaTemasPorUsuario" class="table table-striped table-bordered" style="width:100%">
		        <thead>
		            <tr>
		                <th>Nombre Tema</th>
		                <th>Notificaciones</th>
		            </tr>
		        </thead>
		        <tbody>
		        </tbody>
		    </table>
		</div>		
	</div>



	<div id="divContenidoNotificar" style="display: none" class="divsContenido">
		<div>
			<h1 style="text-align:center;">CREAR NOTIFICACION</h1>
		</div>
		<form id="formularioNuevaNotificacion">
			<div class="container">
				<div class="row">
					<div class="col-md-6">
						<label>Tema Origen:</label>
						<select id="selectTemaOrigen" 
							class="selectpicker" 
							data-live-search="true" 
							placeholder="Nada seleccionado" 
							onchange="actualizarTablaUsuariosXTema('tablaUsuariosTemaOrigen', this.value)"></select>
						<p></p>
						<h6 style="text-align:center;"><strong>Usuarios del Tema Origen:</strong></h6>
						<table id="tablaUsuariosTemaOrigen" class="table table-striped table-bordered" style="width:100%">
					        <thead>
					            <tr>
					                <th>Número</th>
					                <th>Nombre</th>
					            </tr>
					        </thead>
					        <tbody>
					        </tbody>
					    </table>
					</div>
					<div class="col-md-6">
						<label>Tema Destino:</label>
						<select id="selectTemaDestino" 
							class="selectpicker" 
							data-live-search="true" 
							placeholder="Nada seleccionado" 
							onchange="actualizarTablaUsuariosXTema('tablaUsuariosTemaDestino', this.value)"></select>
						<p></p>
						<h6 style="text-align:center;"><strong>Usuarios del Tema Destino:</strong></h6>
						<table id="tablaUsuariosTemaDestino" class="table table-striped table-bordered" style="width:100%">
					        <thead>
					            <tr>
					                <th>Número</th>
					                <th>Nombre</th>
					            </tr>
					        </thead>
					        <tbody>
					        </tbody>
					    </table>
					</div>
				</div>
				<br/>
				<div class="row">
					<label class="col-md-1 offset-md-3 bold">
						Titulo:
					</label>
					<div class="col-md-4">
						<input
							class="form-control"
							id="inputTituloNuevaNotificacion"
							name="inputTituloNuevaNotificacion"
							required="required"													
							type="text"
							onblur="this.value=this.value.toUpperCase();"
							maxlength="100"
						/>
					</div>
				</div>
				<br/>
				<div class="row">
					<label class="col-md-1 offset-md-3 bold"> 
						Descripción:
					</label>
					<div class="col-md-4">
						<textarea
							class="form-control"
							id="inputDescripcionNuevaNotificacion"
							name="inputDescripcionNuevaNotificacion"
							required="required"													
							type="text"
							onblur="this.value=this.value.toUpperCase();"
							maxlength="100"
						></textarea>
					</div>
					<div class="col-md-1">
						<button class="btn btn-info" type="submit"><i class="bi-arrow-right-square"></i> Notificar</button>				
					</div>
				</div>
				<br/>
			</div>	
		</form>
	</div>



	<div id="divContenidoCrearUsuario" style="display: none" class="divsContenido">
		<div>
			<h1 style="text-align:center;">USUARIOS</h1>
		</div>
		<br/>
		<div class="col-md-2 offset-md-8">
			<button class="btn btn-info" type="button" onclick="modalNuevoUsuario()"><i class="bi-person-plus-fill"></i> Agregar Usuario</button>
		</div>
		<br/>
		<div id="divUsuarios" class="col-md-8 offset-md-2">
			<table id="tablaUsuarios" class="table table-striped table-bordered" style="width:100%">
		        <thead>
		            <tr>
		                <th>Número Usuario</th>
		                <th>Nombre</th>
		                <th>A. Paterno</th>
		                <th>A. Materno</th>
		                <th>EMAIL</th>
		                <th>TEMAS</th>
		            </tr>
		        </thead>
		        <tbody>
		        </tbody>
		    </table>
		</div>
		<br/><br/>
	</div>

	<div class="modal fade" id="modalNuevoUsuario" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	  	<div class="modal-dialog" role="document">
		    <div class="modal-content">
		      	<div class="modal-header">
			        <h5 class="modal-title" id="exampleModalLabel">Nuevo Usuario</h5>
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			          <span aria-hidden="true">&times;</span>
			        </button>
		      	</div>
		      	<div class="modal-body">
			        <form id="formularioNuevoUsuario">
				    	<div class="row">
							<label class="col-md-3 bold">
								Número:
							</label>
							<div class="col-md-9">
								<input
									class="form-control"
									id="inputNumeroNuevoUsuario"
									name="inputNumeroNuevoUsuario"
									required="required"													
									type="number"
									onblur="this.value=this.value.toUpperCase();"
									maxlength="10"
								/>
							</div>
						</div>
						<br/>
						<div class="row">
							<label class="col-md-3 bold">
								Nombre:
							</label>
							<div class="col-md-9">
								<input
									class="form-control"
									id="inputNombreNuevoUsuario"
									name="inputNombreNuevoUsuario"
									required="required"													
									type="text"
									onblur="this.value=this.value.toUpperCase();"
									maxlength="100"
								/>
							</div>
						</div>
						<br/>
						<div class="row">
							<label class="col-md-3 bold">
								Apellido Paterno:
							</label>
							<div class="col-md-9">
								<input
									class="form-control"
									id="inputApellidoPaternoNuevoUsuario"
									name="inputApellidoPaternoNuevoUsuario"
									required="required"													
									type="text"
									onblur="this.value=this.value.toUpperCase();"
									maxlength="100"
								/>
							</div>
						</div>
						<br/>
						<div class="row">
							<label class="col-md-3 bold">
								Apellido Materno:
							</label>
							<div class="col-md-9">
								<input
									class="form-control"
									id="inputApellidoMaternoNuevoUsuario"
									name="inputApellidoMaternoNuevoUsuario"
									required="required"													
									type="text"
									onblur="this.value=this.value.toUpperCase();"
									maxlength="100"
								/>
							</div>
						</div>
	                    <br/>	
	                    <div class="row">
							<label class="col-md-3 bold">
								email:
							</label>
							<div class="col-md-9">
								<input
									class="form-control"
									id="inputEmailNuevoUsuario"
									name="inputEmailNuevoUsuario"
									required="required"													
									type="text"
									maxlength="100"
								/>
							</div>
						</div>
	                    <br/>
							
						<div class="externo">
							<div class="modal-footer interno">
								<button type="button" class="btn btn-default btn-outline" data-dismiss="modal">Salir</button>
								<input type="submit" id="btnCrearUsuario" class="btn dark btn-outline" value="Guardar"/>
							</div>
						</div>							
		      		</form>	
		      	</div>		      	
		    </div>
	  	</div>
	</div>




	<div id="divContenidoCrearTema" style="display: none" class="divsContenido">
		<div>
			<h1 style="text-align:center;">CREAR TEMA</h1>
		</div>
		<br/>
		<div class="col-md-2 offset-md-8">
			<button class="btn btn-info" type="button" onclick="modalNuevoTema()"><i class="bi-file-plus"></i> Agregar Tema</button>
		</div>
		<br/>
		<div id="divTemas" class="col-md-8 offset-md-2">
			<table id="tablaTemas" class="table table-striped table-bordered" style="width:100%">
		        <thead>
		            <tr>
		                <th>Nombre Tema</th>
		                <th>Descripción</th>
		                <th>Usuarios</th>
		            </tr>
		        </thead>
		        <tbody>
		        </tbody>
		    </table>
		</div>
		<br/><br/>		
	</div>

	<div class="modal fade" id="modalNuevoTema" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
	  	<div class="modal-dialog" role="document">
		    <div class="modal-content">
		      	<div class="modal-header">
			        <h5 class="modal-title" id="exampleModalLabel">Nuevo Tema</h5>
			        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
			          <span aria-hidden="true">&times;</span>
			        </button>
		      	</div>
		      	<div class="modal-body">
			        <form id="formularioNuevoTema">
						<div class="container">
							<div class="row">
								<label class="col-md-3 bold">
									Nombre:
								</label>
								<div class="col-md-9">
									<input
										class="form-control"
										id="inputNombreNuevoTema"
										name="inputNombreNuevoTema"
										required="required"													
										type="text"
										maxlength="100"
									/>
								</div>
							</div>
							<br/>
							<div class="row">
								<label class="col-md-3 bold"> 
									Descripción:
								</label>
								<div class="col-md-9">
									<textarea
										class="form-control"
										id="inputDescripcionNuevoTema"
										name="inputDescripcionNuevoTema"
										required="required"													
										type="text"
										onblur="this.value=this.value.toUpperCase();"
									></textarea>
								</div>					
							</div>
							<br/>
							<div class="row">
								<div class="col-md-1 offset-md-4">
									<button class="btn btn-info" type="submit"><i class="bi-shield-fill-plus"></i> Crear Tema</button>				
								</div>
							</div>
						</div>	
					</form>	
		      	</div>		      	
		    </div>
	  	</div>
	</div>





	<script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
	<script src="./js/jquery.validate.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/2.0.1/js/toastr.js"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/bootstrap-select@1.13.14/dist/js/bootstrap-select.min.js"></script>
	<script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
	<script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap4.min.js"></script>
	<script src="https://momentjs.com/downloads/moment.js"></script>
	<script src="https://cdn.jsdelivr.net/gh/bbbootstrap/libraries@main/choices.min.js"></script>
	<script src="./js/sweetalert.min.js" type="text/javascript"></script>
 	<script src="./js/ui-sweetalert.min.js" type="text/javascript"></script>

	<script type="text/javascript">
		function activarPositionToastr(posicion){
			if(posicion == 'arriba'){
				//CONFIGURACION DEL TOASTR
				toastr.options = {
							"closeButton": true,
							"debug": true,
							"newestOnTop": false,
							"progressBar": true,
							"positionClass": "toast-top-right",
							"preventDuplicates": false,
							"showDuration": "300",
							"hideDuration": "1000000",
							"timeOut": "5000",
							"extendedTimeOut": "1000",
							"showEasing": "swing",
							"hideEasing": "linear",
							"showMethod": "fadeIn",
							"hideMethod": "fadeOut"
						};
			}

			if(posicion == 'centrado-abajo'){
				//CONFIGURACION DEL TOASTR
				toastr.options = {
							"closeButton": true,
							"debug": true,
							"newestOnTop": false,
							"progressBar": true,
							"positionClass": "toast-bottom-full-width",
							"preventDuplicates": false,
							"showDuration": "300",
							"hideDuration": "1000000",
							"timeOut": "5000",
							"extendedTimeOut": "1000",
							"showEasing": "swing",
							"hideEasing": "linear",
							"showMethod": "fadeIn",
							"hideMethod": "fadeOut"
						};
			}
		}



	//<!-- START MENU NOTIFICACIONES >> CONECTAR TEMA *******************************************************************************************************************-->
		$(document).ready(function() {
    		$('#example').DataTable();


    		actualizarMultiSelects();
		} );

		/*$('#tablaTemas')
				        .on( 'order.dt',  function () { actualizarMultiSelects(); } )
				        .on( 'search.dt', function () { actualizarMultiSelects(); } )
				        .on( 'page.dt',   function () { actualizarMultiSelects(); } )
				        .DataTable();*/


		function actualizarMultiSelects(){
			var multipleCancelButton = new Choices('.multiSelectUsuarios', {
				removeItemButton: true,
				//maxItemCount:5,
				//searchResultLimit:5,
				//renderChoiceLimit:5
			});
		}

		function mostrarContenido(idComponente){
			//GENERAR NOMBRE DEL DIV QUE SE VA A MOSTRAR
			var nombreComponente = 'divContenido'+idComponente.split('contenido')[1];
			var divsContenido = document.getElementsByClassName('divsContenido');			
			for(i = 0; i < divsContenido.length; i++){
				divsContenido[i].style.display = 'none';
			}
			document.getElementById(nombreComponente).style.display = 'block';
		}

		actualizarUsuariosSelects();
		actualizarTemasSelects();		

		function conectar(){			
			_numeroUsuario = document.getElementById("selectUsuario").value;			

			//TEMAS A LOS QUE ESTA CONECTADO EL USUARIO
			$.ajax({
				type : 'GET',
				url : _baseURL+'/notifications/user-themes/'+_numeroUsuario,
				async: false,
				success : function(temas) {
					/*LA FORMA DE CONECTARSE AL SERVIDOR DE NOTIFICACIONES ES A TRAVES DEL NUMERO DE EMPLEADO
							SOLO CONECTAR AL SERVIDOR SI EL USUARIO TIENE TEMAS
					*/
					if(es != null){
						if(es.readyState == 1){
							cerrarConexion();
						}
					}
					es = new EventSource(_baseURL+"/SSE/configuracion/notificaciones/"+_numeroUsuario);
					
					//DETECTAR CONEXION ABIERTA
					es.onopen = function() {
					   validarStatusConexion();
					};
					//DETECTAR ERRORES
					es.onerror = function(e) {
			            validarStatusConexion();
			        };
			        
					//POR CADA TEMA, DEBE CREAR UN ESCUCHADOR
				    temas.forEach(tema => {
				    	//console.log("Se conectó al tema: "+tema.theme_nombre)
				    	//1)AGREGAR ESCUCHADOR POR CADA TEMA
						es.addEventListener(tema.theme_nombre, event => {
							let dataNotificacion = (event.data);
							
							//SI NO EXISTE LA NOTIFICACION RECIBIRLA
							if(JSON.parse(dataNotificacion).numero_usuario_dirigida == _numeroUsuario){								
								console.log("Del tema: " + tema.theme_nombre + " -- Se recibió notificación: "+dataNotificacion);
								//agregarNotificacion(JSON.parse(dataNotificacion), 'arriba');
								recorrerNotificaciones();
								//toastr.info(JSON.parse(event.data).descripcion,'Nueva Notificacion', {timeOut: 3000,showEasing:"swing",positionClass:"toast-top-right"});

								activarPositionToastr('arriba');
								toastr["success"](JSON.parse(event.data).descripcion, "Nueva Notificación");
							}
						}, false);
				    });

				    //2)AGREGAR TEMAS A LA TABLA
				    $('#tablaTemasPorUsuario').DataTable({ 
					        "destroy": true,
					        "bDeferRender": true,
					        "aaSorting": [[1, 'desc']],
					        "data": temas, 
					        "columns":[					            
					            {"data":"theme_nombre"},
					            {"data":"theme_nombre"}
					        ],
					        language: {
					            search:         "Buscar&nbsp;:",
					            lengthMenu: "_MENU_ renglones",
					            zeroRecords: "No se encontraron resultados",
					            info:           "Mostrando _START_ a _END_ de _TOTAL_ renglones totales",
					            infoEmpty:      "Mostrando 0 a 0 de 0 renglones totales",
					            infoFiltered:   "(Filtrado _START_ de _MAX_ renglones)"
					        }
					});
				}
			});			

			recorrerNotificaciones();
		}

		function actualizarUsuariosSelects(){
			//LIMPIAR SELECT DE USUARIOS
			$('#selectUsuario').empty();
			$.ajax({
					type : 'GET',
					url : _baseURL+'/user',
					async: false,
					success : function(usuarios) {
					    //POR CADA USUARIO AGREGARLO AL SELECT
					    usuarios.forEach(usuario => {
					    	$('#selectUsuario').append(`<option value=${usuario.numero}>${usuario.nombre} ${usuario.paterno} ${usuario.materno}</option>`);
					    });
					    $('#selectUsuario').selectpicker('refresh'); 
					    $('#selectUsuario').val(usuarios[0].numero).trigger('change');

					    llenarTablaUsuarios(usuarios);
					}
			});
		}

		function actualizarTablaUsuariosXTema(nombreTabla, idTema){
			//console.log(nombreTabla, idTema)
			$.ajax({
					type : 'GET',
					url : _baseURL+'/theme/'+idTema+'/users',
					async: false,
					success : function(usuarios) {
					    $('#'+nombreTabla).DataTable({ 
					        "destroy": true,
					        "bDeferRender": true,
					        "aaSorting": [[1, 'desc']],
					        "data": usuarios, 
					        "columns":[					            
					            {"data":"numero"},
					            {
									"render": function ( data, type, full, meta ) {
										return full.nombre + ' ' + full.paterno + ' ' + full.materno;
					                }
								}
					        ],
					        language: {
					            search:         "Buscar&nbsp;:",
					            lengthMenu: "_MENU_ renglones",
					            zeroRecords: "No se encontraron resultados",
					            info:           "Mostrando _START_ a _END_ de _TOTAL_ renglones totales",
					            infoEmpty:      "Mostrando 0 a 0 de 0 renglones totales",
					            infoFiltered:   "(Filtrado _START_ de _MAX_ renglones)"
					        }
						});
					}
			});
			
		}

		function agregarNotificacion(notificacion, ubicacion){
			//SI NO EXISTE LA NOTIFICACION SE AGREGA
			if(!document.getElementById("divNotificacionNo"+notificacion.id)){
				//Estilos notificaciones leidas
	            var stylecolorBack = 'background-color:#fff';
	            var stylecolor = 'fff';
	            var icono = 'bi-envelope-check';
	            //Estilos notificaciones NO leidas
	            if(notificacion.lectura_por_usuario == 0){
	                //cantidadNotiSinLeer ++;
	                stylecolorBack = 'background-color:#e3e7fb';
	                stylecolor = '#e3e7fb';
	                icono = 'bi-envelope-exclamation-fill';
	            }
	            
	            var liNotificacion = `	<div class="dropdown-item" id="divNotificacionNo${notificacion.id}" style="${stylecolorBack}">
									        <div class="row">
									            <div class="col-md-2 profile-img">
										            <i class="${icono}" style="font-size: 20px;"></i>
									            </div>
									            <div class="col-md-10">
									    	        <a href="javascript:leerNotificacion(${notificacion.id})">
											            <b>${notificacion.titulo}</b> ${notificacion.descripcion}
											            <br>
											            <small>Hace ${notificacion.tiempo_transcurrido}</small> -
											            <small>${moment(notificacion.creado).format("DD/MM/YYYY h:mm:ss")}</small>
											        </a>
											    </div>
										    </div>
								        </div>`;
				if(ubicacion == 'arriba'){
					$("#divNotificaciones").prepend(liNotificacion);
				}
				if(ubicacion == 'abajo'){
					$('#divNotificaciones').append(liNotificacion);
				}
				//AGREGAR NOTIFICACION AL ARREGLO
				_notificaciones.push(notificacion);
			}else{
				console.log("Ya existe esa notificacion")
			}			
		}

		function recorrerNotificaciones(){
			$("#divNotificaciones").empty();
            //START NOTIFICACIONES ANTERIORES DEL USUARIO****************************************************************************************
            $.ajax({
                type : 'GET',
                url : _baseURL+'/notifications/user/'+_numeroUsuario,
                data: {statusLecturaUsuario: '%'},
                async: false,
                success : function(notificaciones){     
                    _notificaciones = notificaciones;
                }
            });

            var cantidadNotiSinLeer = 0;
            _notificaciones.forEach(notificacion => {
            	agregarNotificacion(notificacion, 'abajo'); 
            	//CONTAR NOTIFICACIONES SIN LEER
            	if(notificacion.lectura_por_usuario == 0){
                	cantidadNotiSinLeer ++;
                }   
            });
            //NOTIFICACIONES SIN LEER
            $("#spanCantidadNotificacionesSinLeer").html(cantidadNotiSinLeer);
            //END NOTIFICACIONES ANTERIORES DEL USUARIO*******************************************************************************************
		}

		function cerrarConexion(){
			$('#tablaTemasPorUsuario').dataTable().fnClearTable();
			es.close();
			document.getElementById("spanCantidadNotificacionesSinLeer").innerHTML = 0;
			$("#divNotificaciones").empty();
			validarStatusConexion();			
		}

		function validarStatusConexion(){
			document.getElementById('labelDesconectado').style.display = 'none';
			document.getElementById('labelConectado').style.display = 'none';

			//console.log(es.readyState)
			//CONEXION ABIERTA
			if(es.readyState == 1){
				document.getElementById('labelConectado').style.display = 'block';
			}
			//CONEXION CERRADA
			if(es.readyState == 2){
				document.getElementById('labelDesconectado').style.display = 'block';
			}
			//SIN CONEXION
			if(es.readyState == 0){
				document.getElementById('labelDesconectado').style.display = 'block';
			}
		}

		function leerNotificacion(idNotificacion){
			$.ajax({
			        type : 'PUT',
			        url : _baseURL+'/notifications/'+idNotificacion+'/user/'+_numeroUsuario,
			        async : false,
			        success : function(notificacionLeida) {
			        	recorrerNotificaciones();
			        	document.getElementById("divVerNotificaciones").classList.add("show");
			        }
			});
		}

		function crearNotificacion(){
			var objNotificacion = 	{
								  	//"adicionales": document.getElementById("inputApellidoMaternoNuevoUsuario").value,
								  	"theme_id_origen": document.getElementById("selectTemaOrigen").value,
								  	"theme_id_destino": document.getElementById("selectTemaDestino").value,
								  	"titulo": document.getElementById("inputTituloNuevaNotificacion").value,
								  	"descripcion": document.getElementById("inputDescripcionNuevaNotificacion").value
								}
			//console.log(objNotificacion)
			$.ajax({
				type : 'POST',
				url : _baseURL+'/notifications',
				contentType : 'application/json; charset=utf-8',
				data : JSON.stringify(objNotificacion),									
				success : function(notificacion) {
					activarPositionToastr('centrado-abajo');
					toastr["success"]("Notificación creada con éxito !!", "Nueva Notificación");

					//LIMPIAR
					document.getElementById("inputTituloNuevaNotificacion").value = '';
					document.getElementById("inputDescripcionNuevaNotificacion").value = '';
				},
				error : function(response) {
					console.log(response)
					if(response.readyState == 0){
						errorSeguridadKeyCloak();
					}else{	
						activarPositionToastr('centrado-abajo');					
						toastr["error"]("No se pudo crear la notificacion", "Error Nueva Notificación");
					}
				}
			});
		}	
	//<!-- END MENU NOTIFICACIONES >> CONECTAR TEMA *******************************************************************************************************************-->







	//<!-- START MENU USUARIOS*******************************************************************************************************************-->	
		function llenarTablaUsuarios(usuarios){
			$('#tablaUsuarios').DataTable({ 
					        "destroy": true,
					        "bDeferRender": true,
					        "aaSorting": [[0, 'asc']],
					        "data": usuarios, 
					        "columns":[					            
					            {"data":"numero"},
					            {"data":"nombre"},
					            {"data":"paterno"},
					            {"data":"materno"},
					            {"data":"email"},
					            {"data":"id"}
					        ],
					        language: {
					            search:         "Buscar&nbsp;:",
					            lengthMenu: "_MENU_ renglones",
					            zeroRecords: "No se encontraron resultados",
					            info:           "Mostrando _START_ a _END_ de _TOTAL_ renglones totales",
					            infoEmpty:      "Mostrando 0 a 0 de 0 renglones totales",
					            infoFiltered:   "(Filtrado _START_ de _MAX_ renglones)"
					        }
					});
		}

		function modalNuevoUsuario(){
			$('#modalNuevoUsuario').modal('show')
		}	

		function crearUsuario(){
			var objUsuario = 	{
								  	"materno": document.getElementById("inputApellidoMaternoNuevoUsuario").value,
								  	"nombre": document.getElementById("inputNombreNuevoUsuario").value,
								  	"numero": document.getElementById("inputNumeroNuevoUsuario").value,
								  	"paterno": document.getElementById("inputApellidoPaternoNuevoUsuario").value,
								  	"email": document.getElementById("inputEmailNuevoUsuario").value
								}//jakqueline.herrera@turbomaquinas.com
			$.ajax({
				type : 'POST',
				url : _baseURL+'/user',
				contentType : 'application/json; charset=utf-8',
				data : JSON.stringify(objUsuario),									
				success : function(usuario) {
					//console.log("nuevo usuario creado: "+usuario)
					activarPositionToastr('centrado-abajo');
					toastr["success"]("Usuario creado con éxito !!", "Nuevo Usuario");
					actualizarUsuariosSelects();

					//LIMPIAR
					document.getElementById("inputApellidoMaternoNuevoUsuario").value = '';
					document.getElementById("inputNombreNuevoUsuario").value = '';
					document.getElementById("inputNumeroNuevoUsuario").value = '';
					document.getElementById("inputApellidoPaternoNuevoUsuario").value = '';
					document.getElementById("inputEmailNuevoUsuario").value = '';
				},
				error : function(response) {
					console.log(response)
					if(response.readyState == 0){
						errorSeguridadKeyCloak();
					}else{	
						activarPositionToastr('centrado-abajo');					
						toastr["error"]("No se pudo crear el usuario", "Error Nuevo Usuario");
					}
				}
			});
		}	
	//<!-- END MENU USUARIOS*******************************************************************************************************************-->




	//<!-- START MENU TEMAS*******************************************************************************************************************-->	
		function modalNuevoTema(){
			$('#modalNuevoTema').modal('show')
		}

		function actualizarTemasSelects(){
			//LIMPIAR SELECT DE USUARIOS
			$('#selectTemaOrigen').empty();
			$('#selectTemaDestino').empty();
			$.ajax({
					type : 'GET',
					url : _baseURL+'/theme',
					async: false,
					success : function(temas) {
					    //POR CADA USUARIO AGREGARLO AL SELECT
					    temas.forEach(tema => {
					    	$('#selectTemaOrigen').append(`<option value=${tema.id}>${tema.nombre}</option>`);
					    	$('#selectTemaDestino').append(`<option value=${tema.id}>${tema.nombre}</option>`);
					    });
					    $('#selectTemaOrigen').selectpicker('refresh'); 
					    $('#selectTemaOrigen').val(temas[0].id).trigger('change');

					    $('#selectTemaDestino').selectpicker('refresh'); 
					    $('#selectTemaDestino').val(temas[0].id).trigger('change');

					    //ACTUALIZAR TABLAS USUARIOS X TEMA
					    actualizarTablaUsuariosXTema('tablaUsuariosTemaOrigen', temas[0].id);
					    actualizarTablaUsuariosXTema('tablaUsuariosTemaDestino', temas[0].id);

					    llenarTablaTemas(temas);
					}
			});
		}


		function crearTema(){
			var objTema = 	{
								  	"nombre": document.getElementById("inputNombreNuevoTema").value,
								  	"descripcion": document.getElementById("inputDescripcionNuevoTema").value
								}
			$.ajax({
				type : 'POST',
				url : _baseURL+'/theme',
				contentType : 'application/json; charset=utf-8',
				data : JSON.stringify(objTema),									
				success : function(tema) {
					activarPositionToastr('centrado-abajo');
					toastr["success"]("Tema creado con éxito !!", "Nuevo Tema");
					actualizarTemasSelects();

					//LIMPIAR
					document.getElementById("inputNombreNuevoTema").value = '';
					document.getElementById("inputDescripcionNuevoTema").value = '';
				},
				error : function(response) {
					console.log(response)
					if(response.readyState == 0){
						errorSeguridadKeyCloak();
					}else{	
						activarPositionToastr('centrado-abajo');					
						toastr["error"]("No se pudo crear el tema", "Error Nuevo Tema");
					}
				}
			});
		}

		function llenarTablaTemas(temas){
			//RECUPERAR USUARIOS
			let usuariosTodos = null;
			$.ajax({
					type : 'GET',
					url : _baseURL+'/user',
					async: false,
					success : function(users) {
					    usuariosTodos = users;
					}
			});

			$('#tablaTemas').DataTable({ 
					        "destroy": true,
					        "bDeferRender": true,
					        "aaSorting": [[0, 'asc']],
					        "data": temas, 
					        "columns":[					            
					            {"data":"nombre"},
					            {"data":"descripcion"},
					            {
									"render": function ( data, type, full, meta ) {
										var options = ``;
										var usuariosSeleccionados = full.usuarios;
										if(usuariosSeleccionados != null){
											usuariosSeleccionados.forEach(usuario => {
												options += `<option value="${usuario.id}" selected="selected">${usuario.nombre +" "+ usuario.paterno +" "+ usuario.materno}</option>`;
											});
										}

										var banderaExisteUsuario = false;
										if(usuariosTodos != null){
											usuariosTodos.forEach(usuario => {
												banderaExisteUsuario = false;
												if(usuariosSeleccionados != null){
													usuariosSeleccionados.forEach(userSeleccionado => {
														if(userSeleccionado.id == usuario.id){
															banderaExisteUsuario = true;
														}
													});
													if(banderaExisteUsuario == false){
														options += `<option value="${usuario.id}">${usuario.nombre +" "+ usuario.paterno +" "+ usuario.materno}</option>`;
													}
														
												}else{
													options += `<option value="${usuario.id}">${usuario.nombre +" "+ usuario.paterno +" "+ usuario.materno}</option>`;
												}											
											});
										}

										return `<div class="row d-flex justify-content-center mt-100">
												    <div class="col-md-12"> 
												    	<select 
												    	id="multiSelectUsuariosTema${full.id}" 
												    	class="multiSelectUsuarios" 
												    	placeholder="Agregar Usuarios" 
												    	multiple
												    	onchange="cambiarUsuarioATema(this.id, ${full.id})">
												            ${options}
												        </select> 
												    </div>
												</div>`;
					                }
								}
					        ],
					        language: {
					            search:         "Buscar&nbsp;:",
					            lengthMenu: "_MENU_ renglones",
					            zeroRecords: "No se encontraron resultados",
					            info:           "Mostrando _START_ a _END_ de _TOTAL_ renglones totales",
					            infoEmpty:      "Mostrando 0 a 0 de 0 renglones totales",
					            infoFiltered:   "(Filtrado _START_ de _MAX_ renglones)"
					        }
					});
		}

		function cambiarUsuarioATema(idComponente, idTema){
			//console.log([...document.getElementById(idComponente).options])
			var objUserTema = [];
			var options = [...document.getElementById(idComponente).options];
			
			options.forEach(optionSelected => {
				objUserTema.push(	{
									   "theme_id": idTema,
									   "users_id": parseInt(optionSelected.value)
									});
			});

			//MANDAR OBJETO CON USUARIO EN 0 PARA ELIMINAR DE LA BD
			if(objUserTema.length == 0){
				objUserTema.push(	{
									   "theme_id": idTema,
									   "users_id": 0
									});
			}

			$.ajax({
				type : 'PUT',
				url : _baseURL+'/belong',
				contentType : 'application/json; charset=utf-8',
				data : JSON.stringify(objUserTema),									
				success : function(usuarios) {
					activarPositionToastr('centrado-abajo');
					toastr["success"]("Usuarios actualizados con éxito !!", "Cambio en Usuarios");
				},
				error : function(response) {
					console.log(response)
					if(response.readyState == 0){
						errorSeguridadKeyCloak();
					}else{	
						activarPositionToastr('centrado-abajo');					
						toastr["error"]("No se pudo agregar el usuario", "Error Agregar Usuario al tema");
					}
				}
			});
		}
	
	//<!-- END MENU TEMAS*******************************************************************************************************************-->



	//<!-- START GENERAL*******************************************************************************************************************-->	
		$(document).ready(function () {
		    $('#formularioNuevoUsuario').validate({
		        rules: {},
		        messages: {
					/*inputNuevoProcesoHorasPlaneadas:{
						max : "Por favor introduce un valor menor o igual que 1000",
						min : "Por favor introduce un valor mayor o igual que 0"
					}*/
				},
		        submitHandler: function (form) {
		        	crearUsuario();        	
		        }
		    });

		    $('#formularioNuevaNotificacion').validate({
		        rules: {},
		        messages: {
					/*inputNuevoProcesoHorasPlaneadas:{
						max : "Por favor introduce un valor menor o igual que 1000",
						min : "Por favor introduce un valor mayor o igual que 0"
					}*/
				},
		        submitHandler: function (form) {
		        	crearNotificacion();        	
		        }
		    });

		    $('#formularioNuevoTema').validate({
		        rules: {},
		        messages: {
					/*inputNuevoProcesoHorasPlaneadas:{
						max : "Por favor introduce un valor menor o igual que 1000",
						min : "Por favor introduce un valor mayor o igual que 0"
					}*/
				},
		        submitHandler: function (form) {
		        	crearTema();        	
		        }
		    });    	    
		});


		function errorSeguridadKeyCloak(){
			swal({
				title: "Tiempo de Sesión Terminado",
				html: true,
				text : "Por favor es necesario abrir nuevamente la página principal del sistema",
				type: "warning",
				showCancelButton: true,
				allowOutsideClick: false,
				confirmButtonClass: "btn-info",
				confirmButtonText: "Abrir Página Principal",
				cancelButtonText: "Cancelar",
				showLoaderOnConfirm: true,
				closeOnConfirm: false,
				closeOnCancel: true
				},
				function(isConfirm) {
					if (isConfirm) {
						swal.close();	
						//window.open('/turboerp/index', '_blank');			
		            }
				}
			);
		}
	</script>
	<!-- END GENERAL*******************************************************************************************************************-->
</body>
</html>